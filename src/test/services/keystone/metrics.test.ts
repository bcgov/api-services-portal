import { getServiceMetrics, calculateStats } from '../../../services/keystone';
import numeral from 'numeral';

const queries = [
  {
    name: 'GetServiceMetrics',
    data: {
      data: {
        allMetrics: [
          {
            query: 'kong_http_requests_hourly_service',
            day: '2021-10-17',
            metric: '{"service":"aps-authz"}',
            values:
              '[[1634454000,"0"],[1634457600,"0"],[1634461200,"0"],[1634464800,"0"],[1634468400,"0"],[1634472000,"0"],[1634475600,"6.02510460251046"],[1634479200,"70.2928870292887"],[1634482800,"0"],[1634486400,"0"],[1634490000,"0"],[1634493600,"0"],[1634497200,"0"],[1634500800,"0"],[1634504400,"0"],[1634508000,"0"],[1634511600,"0"],[1634515200,"0"],[1634518800,"0"],[1634522400,"31.12999450722631"],[1634526000,"1.00418410041841"],[1634529600,"0"],[1634533200,"0"],[1634536800,"0"]]',
            service: { name: 'aps-authz' },
          },
          {
            query: 'kong_http_requests_hourly_service',
            day: '2021-10-18',
            metric: '{"service":"aps-authz"}',
            values:
              '[[1634540400,"0"],[1634544000,"0"],[1634547600,"0"],[1634551200,"0"],[1634554800,"0"],[1634558400,"0"],[1634562000,"0"],[1634565600,"0"],[1634569200,"0"],[1634572800,"0"],[1634576400,"5.02092050209205"],[1634580000,"166.69574218576506"],[1634583600,"2.00836820083682"],[1634587200,"0"],[1634590800,"1.00418410041841"],[1634594400,"0"],[1634598000,"15.06276150627615"],[1634601600,"64.26800399851074"],[1634605200,"7.02928870292887"],[1634608800,"1.00418410041841"],[1634612400,"0"],[1634616000,"0"],[1634619600,"0"],[1634623200,"0"]]',
            service: { name: 'aps-authz' },
          },
          {
            query: 'kong_http_requests_hourly_service',
            day: '2021-10-19',
            metric: '{"service":"aps-authz"}',
            values:
              '[[1634626800,"0"],[1634630400,"0"],[1634634000,"0"],[1634637600,"0"],[1634641200,"0"],[1634644800,"0"],[1634648400,"0"],[1634652000,"0"],[1634655600,"0"],[1634659200,"4.01673640167364"],[1634662800,"2.0112523984883204"],[1634666400,"0"],[1634670000,"12.071579602510461"],[1634673600,"1.00418410041841"],[1634677200,"40.20372177799439"],[1634680800,"36.15063601831215"],[1634684400,"4.01673640167364"],[1634688000,"1.00418410041841"],[1634691600,"0"],[1634695200,"0"],[1634698800,"0"],[1634702400,"0"],[1634706000,"0"],[1634709600,"0"]]',
            service: { name: 'aps-authz' },
          },
          {
            query: 'kong_http_requests_hourly_service',
            day: '2021-10-20',
            metric: '{"service":"aps-authz"}',
            values:
              '[[1634713200,"0"],[1634716800,"0"],[1634720400,"0"],[1634724000,"0"],[1634727600,"0"],[1634731200,"0"],[1634734800,"0"],[1634738400,"1.00418410041841"],[1634742000,"0"],[1634745600,"0"],[1634749200,"7.02928870292887"],[1634752800,"8.03347280334728"],[1634756400,"27.11297071129707"],[1634760000,"26.10878661087866"],[1634763600,"0"],[1634767200,"34.14225941422594"],[1634770800,"539.7861234638355"],[1634774400,"173.72384937238493"],[1634778000,"32.13389121338912"],[1634781600,"96.40167364016735"],[1634785200,"0"],[1634788800,"0"],[1634792400,"0"],[1634796000,"0"]]',
            service: { name: 'aps-authz' },
          },
          {
            query: 'kong_http_requests_hourly_service',
            day: '2021-10-21',
            metric: '{"service":"aps-authz"}',
            values:
              '[[1634799600,"0"],[1634803200,"0"],[1634806800,"0"],[1634810400,"0"],[1634814000,"0"],[1634817600,"0"],[1634821200,"3.01255230125523"],[1634824800,"0"],[1634828400,"0"],[1634832000,"235.98326359832637"],[1634835600,"226.9734996155761"],[1634839200,"4.01673640167364"],[1634842800,"28.11715481171548"],[1634846400,"10.0418410041841"],[1634850000,"38.15899581589958"],[1634853600,"14.05857740585774"],[1634857200,"15.06276150627615"],[1634860800,"15.06276150627615"],[1634864400,"0"],[1634868000,"0"],[1634871600,"0"],[1634875200,"0"],[1634878800,"3.01255230125523"],[1634882400,"0"]]',
            service: { name: 'aps-authz' },
          },
        ],
      },
    },
  },
];

describe('KeystoneJS', function () {
  const context = {
    executeGraphQL: (q: any) => {
      if (q.query.indexOf(queries[0].name) != -1) {
        return queries[0].data;
      }
    },
  };

  describe('test getServiceMetrics', function () {
    it('it should be successful', async function () {
      const days = [
        '2021-10-21',
        '2021-10-20',
        '2021-10-19',
        '2021-10-18',
        '2021-10-17',
      ];
      const service = 'aps-authz';

      const metrics = await getServiceMetrics(context, service, days);
      expect(metrics.length).toBe(5);

      const { totalRequests } = calculateStats(metrics);
      expect(totalRequests).toBe(2010);

      const daily = numeral(totalRequests).format('0.0a');
      expect(daily).toBe('2.0k');
    });
  });
});
